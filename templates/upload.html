<!DOCTYPE html>
<html lang="pt-br">
<head>
    </head>
<body>
    <div class="container">
        <div class="card shadow p-4" style="width: 90%; max-width: 1200px;">
            <h1 class="mb-4 text-center">Análise de Dados CSV</h1>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="formFile" class="form-label">Selecione o ficheiro CSV:</label>
                    <input class="form-control" type="file" id="formFile" name="file" accept=".csv" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Analisar</button>
            </form>
            <div id="loading" class="mt-3 text-center" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">A carregar...</span>
                </div>
            </div>
            <div id="results" class="mt-4">
                <table id="example" class="display table table-striped table-bordered" style="width:100%"></table>
            </div>
            <div id="downloadLink" class="mt-3 text-center" style="display: none;">
                <a class="btn btn-success" href="/uploads/saved_data.csv" download>Download dos dados editados</a>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script>
        // ... (Código JavaScript abaixo)
        const form = document.getElementById('uploadForm');
const resultsDiv = document.getElementById('results');
const loadingDiv = document.getElementById('loading');
const downloadLink = document.getElementById('downloadLink');

form.addEventListener('submit', (event) => {
    event.preventDefault();

    const formData = new FormData(form);
    resultsDiv.innerHTML = '';
    loadingDiv.style.display = 'block';
    downloadLink.style.display = 'none'; //Esconde o link de download

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log("Resposta do servidor:", response);
        if (!response.ok) {
            return response.json().then(err => {throw new Error(err.error || "Erro no upload")});
        }
        return response.json();
    })
    .then(data => {
        console.log("Dados recebidos:", data);
        loadingDiv.style.display = 'none';

        if (data.error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger" role="alert">${data.error}</div>`;
        } else if (Object.keys(data).length > 0) { //Verifica se o json tem dados
            var editor = new $.fn.dataTable.Editor({
                ajax: "/save_data",
                table: "#example",
                fields: Object.keys(data).map(key => ({ label: key.replace(/_/g, ' ') + ':', name: key })),
            });

            var table = $('#example').DataTable({
                data: Object.values(data).map((_, i) => Object.keys(data).reduce((acc, k) => {
                    acc[k] = data[k] instanceof Array ? data[k][i] : data[k];
                    return acc;
                }, {})),
                columns: Object.keys(data).map(key => ({ data: key, title: key.replace(/_/g, ' ') })),
                select: 'single',
                buttons: [
                    { extend: "create", editor: editor },
                    { extend: "edit", editor: editor },
                    { extend: "remove", editor: editor }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-PT.json',
                }
            });
            downloadLink.style.display = 'block'; //Mostra o link de download
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-warning" role="alert">O ficheiro não tem dados para apresentar.</div>`;
        }
    })
    .catch(error => {
        console.error("Erro no fetch:", error);
        loadingDiv.style.display = 'none';
        resultsDiv.innerHTML = `<div class="alert alert-danger" role="alert">Erro na requisição: ${error}</div>`;
    });
});
    </script>
</body>
</html>
